<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="zpepdi.system.dao.fd.ProjectBudgetDao">
    <resultMap id="queryByProjectId" type="map">
        <result column="year" jdbcType="INTEGER" property="year"/>
        <result column="type0" jdbcType="INTEGER" property="year"/>
        <result column="type1" jdbcType="INTEGER" property="year"/>
        <result column="project_id" jdbcType="CHAR" property="project_id"/>
        <result column="year_budget" jdbcType="DECIMAL" property="year_budget"/>
        <result column="quarter1_budget" jdbcType="DECIMAL" property="quarter1"/>
        <result column="quarter2_budget" jdbcType="DECIMAL" property="quarter2"/>
        <result column="quarter3_budget" jdbcType="DECIMAL" property="quarter3"/>
        <result column="quarter4_budget" jdbcType="DECIMAL" property="quarter4"/>
        <collection property="quarterList" javaType="ARRAYLIST"
                    column="year=year, id = project_id"
                    select="queryQuarterByProjectId"/>
        <collection property="incomeList" javaType="ARRAYLIST"
                    column="year=year, id = project_id,type = type0"
                    select="queryMonthByProjectId"/>
        <collection property="expendList" javaType="ARRAYLIST"
                    column="year=year, id = project_id, type = type1"
                    select="queryMonthByProjectId"/>
    </resultMap>
    <update id="setBudgetMonth">
        insert into project_budget_month(project_id, `month`, `quarter`, `year`, `single`, `type`,
                                         `invoice`,`income`, `remark`, handler,`time` )
        values (#{map.project_id}, #{map.month},#{map.quarter}, #{map.year},#{map.single},
                #{map.type}, #{map.invoice},#{map.income}, #{map.remark}, #{userId},now())
            on duplicate key update
            `invoice` = values(`invoice`),
            `income` = values(`income`),
            `remark` = values(`remark`),
             `time` = values(`time`),
             `handler` = values(`handler`)
    </update>
    <update id="setBudgetYear">
        insert into project_budget_year(project_id, `year_budget`, quarter1_budget,quarter2_budget,
                                       quarter3_budget, quarter4_budget, `year`, `time`, handler)
        values (#{map.project_id}, #{map.year_budget}, #{map.quarter1}, #{map.quarter2},
                #{map.quarter3}, #{map.quarter4}, #{map.year}, now(), #{userId})
            on duplicate key update
                                 `year_budget` = values(`year_budget`),
                                 `quarter1_budget` = values(`quarter1_budget`),
                                 `quarter2_budget` = values(`quarter2_budget`),
                                 `quarter3_budget` = values(`quarter3_budget`),
                                 `quarter4_budget` = values(`quarter4_budget`),
                                 `time` = values(`time`),
                                 `handler` = values(`handler`)
    </update>
    <update id="setQuarter">
        insert into project_budget_quarter(project_id, quarter_budget, month1_budget,
                                           month2_budget, month3_budget, year ,quarter, time, handler)
        values(#{map.id}, #{map.quarter_budget}, #{map.month1_budget}, #{map.month2_budget},
               #{map.month3_budget}, #{map.year}, #{map.quarter}, now(), #{userId})
        on duplicate key update
        quarter_budget  = values(quarter_budget),
        month1_budget  = values(month1_budget),
        month2_budget  = values(month2_budget),
        month3_budget  = values(month3_budget),
        `time`  = values(`time`)
    </update>
    <select id="queryByProjectId" resultMap="queryByProjectId">
        select ifnull(`year_budget`,0) as year_budget,
               ifnull(quarter1_budget,0) as quarter1_budget,
               ifnull(quarter2_budget,0) as quarter2_budget,
               ifnull(quarter3_budget,0) as quarter3_budget,
               ifnull(quarter4_budget,0) as quarter4_budget,
               `year`, project_id, 0 as type0, 1 as type1
        from project_budget_year
        where project_id = #{id}
          and `year` = #{year}
    </select>
    <select id="queryMonthByProjectId" resultType="java.util.Map">
        SELECT
            id,
            project_id,
            `month`,
            `quarter`,
            `year`,
            `year`,
            single,
            `type`,
            `invoice`,
            `income`,
            remark,
            `handler`,
            `time`
        FROM
            project_budget_month
        WHERE
            project_id = #{id}
          AND `year` = #{year}
         and type = #{type}
        ORDER BY
            `month`
    </select>
    <select id="queryNowById" resultType="java.util.Map">
        SELECT
            c.id,
            y.year_budget,
            y.quarter1_budget,
            y.quarter2_budget,
            y.quarter3_budget,
            y.quarter4_budget,
            q.quarter_budget,
            q.month1_budget,
            q.month2_budget,
            q.month3_budget,
                SUM( m.invoice ) AS invoice,
            SUM( m1.invoice ) AS invoice1
        FROM
            contract c
                LEFT JOIN project_budget_year y ON c.id = y.project_id
                AND y.`year` = #{year}
                LEFT JOIN project_budget_quarter q ON c.id = q.project_id
                AND q.`year` = #{year}
                AND `quarter` = #{quarter}
                LEFT JOIN project_budget_month m ON c.id = m.project_id
                AND m.`year` = #{year}
                AND m.`month` = #{month}
                LEFT JOIN project_budget_month m1 ON c.id = m1.project_id
                AND m1.`year` = #{nextMonthYear}
                AND m1.`month` = #{nextMonth}
        WHERE
            c.id = #{id}
    </select>
    <select id="queryQuarterByProjectId" resultType="java.util.Map">
        select
            quarter,
            quarter_budget,
            month1_budget,
            month2_budget,
            month3_budget
        from project_budget_quarter
        where project_id = #{id}
        and `year` = #{year}
        order by quarter
    </select>
</mapper>