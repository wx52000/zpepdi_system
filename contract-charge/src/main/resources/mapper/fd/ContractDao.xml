<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="zpepdi.system.dao.fd.ContractDao">
  <resultMap id="ContractMap" type="zpepdi.system.entity.Contract">
    <id column="id" jdbcType="CHAR" property="id" />
    <result column="number" jdbcType="VARCHAR" property="number" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="first_party" jdbcType="VARCHAR" property="firstParty" />
    <result column="business_manage" jdbcType="VARCHAR" property="businessManage" />
    <result column="budget" jdbcType="DECIMAL" property="budget" />
    <result column="money" jdbcType="DECIMAL" property="money" />
    <result column="sign_date" jdbcType="DATE" property="signDate" />
    <result column="settlement" jdbcType="DECIMAL" property="settlement" />
    <result column="attribute" jdbcType="CHAR" property="attribute" />
    <result column="property" jdbcType="VARCHAR" property="property" />
    <result column="type" jdbcType="VARCHAR" property="type" />
    <result column="is_off_shore" jdbcType="INTEGER" property="isOffShore" />
    <result column="state" jdbcType="CHAR" property="state" />
    <result column="complete_state" jdbcType="CHAR" property="completeState" />
    <result column="sponsor_dep" jdbcType="VARCHAR" property="sponsorDep" />
    <result column="classes" jdbcType="VARCHAR" property="classes" />
    <result column="kind" jdbcType="INTEGER" property="kind" />
  </resultMap>
  <select id="query" resultMap="ContractMap">
    SELECT
      id,
      number,
      `name`,
      business_manage,
      first_party,
      budget,
      money,
      cast(sign_date as char(10)) as sign_date,
      settlement,
      attribute,
      property,
      type,
      is_off_shore,
      state,
      sponsor_dep,
      complete_state,
      classes,
      kind
    FROM
      contract
    ORDER BY sign_date DESC
  </select>
  <select id="queryById" resultType="zpepdi.system.entity.Contract">
    SELECT
      c.id,
      c.number,
      c.`name`,
      c.business_manage,
      c.first_party,
      c.budget,
      c.money,
      cast(c.sign_date as char(10)) as sign_date,
      c.settlement,
      c.attribute,
      c.property,
      c.type,
      c.is_off_shore,
      c.state,
      c.sponsor_dep,
      c.complete_state,
      c.classes,
      c.kind,
      s.consultation,
      s.survey,
      s.design,
      s.management,
      s.equipment,
      s.construction,
      s.other,
      s.cost
    FROM
      contract c
    left join contract_split s on c.id = s.contract_id
    where id = #{id}
    ORDER BY sign_date DESC
  </select>
  <select id="contractReceive" resultType="java.util.Map">
    SELECT
      happen_date,
      money,
      manage,
      note,
      receive_date
    FROM
      contract_receivable
    WHERE
        REPLACE ( number, "-", "" ) = REPLACE (#{id},"-","")
  </select>
  <select id="queryPlan" resultType="java.util.Map">
    SELECT
    c.`name`,
    c.number,
    c.money,
    c.business_manage,
    y.year_budget,
    isum.chargeSum,
    isum.addSum,
    iyear.addYear,
    iyear.chargeYear
    FROM
    contract c
    LEFT JOIN invoice_budget_year y ON c.id = y.contract_id
    AND y.`year` = #{year},
    (
    SELECT
    SUM( i.charge ) AS chargeSum,
    SUM( i.added_value ) AS addSum,
    ii.contract_id
    FROM
    invoice_information ii,
    invoice i
    WHERE
    ii.id = i.invoice_information_id
    GROUP BY
    ii.contract_id
    ) AS isum,
    (
    SELECT
    SUM( i.charge ) AS chargeYear,
    SUM( i.added_value ) AS addYear,
    ii.contract_id
    FROM
    invoice_information ii,
    invoice i
    WHERE
    ii.id = i.invoice_information_id
    AND i.out_date &gt;= concat(#{year},"-01-01")
    AND i.out_date &lt; concat(#{year}+1, "-01-01")
    GROUP BY
    ii.contract_id
    ) AS iyear
    WHERE
    isum.contract_id = c.id
    AND iyear.contract_id = c.id
  </select>
</mapper>